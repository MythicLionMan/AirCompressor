<!DOCTYPE html>
<html>
    <head><title>Air Compressor</title></head>
    <link rel="stylesheet" type="text/css" href="style.css"/>
    <link rel="stylesheet" type="text/css" href="pichart.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.0.1/chartjs-plugin-annotation.min.js"></script>
    <script src="utils.js"></script>
    <script src="pressureGauge.js"></script>
    <script>
        let stateMonitor = null;
        let compressorActions = null;
        let chartMonitor = null;
        window.onload = function() {{
            stateMonitor = new StateMonitor('lastUpdateTime', 'tankPressure', 'linePressure');
            compressorActions = new CompressorActions(stateMonitor);
            chartMonitor = new ChartMonitor('compressorTimeline');
            stateMonitor.monitor();
            chartMonitor.monitor();
        }};
    </script>
    <body>
        <h1>Air Compressor</h1>

        <div id="compressorTimelineContainer">
            <canvas id="compressorTimeline"></canvas>
            <div>
                <button onclick="chartMonitor.setChartDurationIndex(0)">Short</button>
                <button onclick="chartMonitor.setChartDurationIndex(1)">Medium</button>
                <button onclick="chartMonitor.setChartDurationIndex(2)">Long</button>
                
                <label for="show_activity">
                    <input type="checkbox" id="show_activity" checked onclick="chartMonitor.setActivityVisibility(this.checked)" />Activity
                </label>                
                <label for="show_commands">
                    <input type="checkbox" id="show_commands" checked onclick="chartMonitor.setCommandVisibility(this.checked)" />Commands
                </label>                
            </div>
        </div>
        <div class="undefined_state">
            <div class='visibleWhenCompressorError' hidden>Warning: server has not responded since <span id='lastUpdateTime'>forever</span></div>
            <div class='visibleWhenSensorError' hidden>Warning: the tank sensor has returned an invalid value. Check the wiring.</div>
            <div>
                <div id="power_light"></div>
                <div id="run_light"></div>
                <div id="pressure_warning"></div>
            </div>
            <table>                
                <tr>
                    <td>
                        <canvas id="tankPressure" width="200" height="200"></canvas>
                        <label for="tankPressure">Tank Pressure</label>
                    </td>
                    <td>
                        <canvas id="linePressure" width="200" height="200"></canvas>
                        <label for="linePressure">Line Pressure</label>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div id="duty" class="pie onePie" style="--percentageOne:{duty}">{duty}</div>
                        <label for="duty">Runtime Last {duty_duration} Seconds</label>
                    </td>
                    <td>
                        Compressor has run for <span id='runtime'>{runtime}</span> since <span id='log_start_time'>{log_start_time}</span>.
                    </td>
                </tr>
                
                <tr><td>System Time</td><td id="system_time">{system_time}</td></tr>
                <tr class="visibleWhenOn" hidden><td>Shutdown Scheduled</td><td id="shutdown">{shutdown}</td></tr>
                <tr class="visibleWhenDutyBlocked" hidden><td>Duty Recovery Time</td><td id="duty_recovery_time">{duty_recovery_time}</td></tr>
            </table>
            <div>
                <button class="hiddenWhenOn" onclick="compressorActions.turnOn()">Turn On</button>
                <button class="visibleWhenOn" hidden onclick="compressorActions.turnOff()">Turn Off</button>
                <button class="visibleWhenOn" hidden onclick="compressorActions.pause()">Pause</button>
                <button class="hiddenWhenRunning" onclick="compressorActions.run()">Run</button>
                <button class="hiddenWhenPurging" onclick="compressorActions.purge()">Purge</button>
            </div>
        </div>
        <h2>Settings <a href="editSettings.html">Edit</a></h2>
        <table>
            <tr><td>Max Duty</td><td>{max_duty}</td></tr>
            <tr><td>Recovery Time</td><td>{recovery_time}</td></tr>
        </table>
    </body>
</html>
